{% extends "base/base.html" %}
{% load static %} <!-- Make sure this is included -->

{% block content %}

<div class="profile-page-container">

    <!-- Profile Picture Section -->
    <div style="text-align: center; margin-bottom: 20px;">
        {% if user.profile.profile_picture %}
            <img src="{{ user.profile.profile_picture.url }}" alt="Profile Picture" style="width: 150px; height: 150px; border-radius: 50%; border: 2px solid #1A3D31;">
        {% else %}
            <img src="{% static 'images/profile-placeholder.png' %}" alt="Default Profile Picture" style="width: 150px; height: 150px; border-radius: 50%; border: 2px solid #1A3D31;">
        {% endif %}
    </div>

    <h1>{{ user.username }}'s Profile</h1>
    <p><strong>Name:</strong> {{ user.get_full_name }}</p> <!-- Full name if both first and last are set -->
    
    <!-- Add Bio Section -->
    <p><strong>Bio:</strong> {{ user.profile.bio }}</p>

    <h2>Created Rooms</h2>
    {% if recent_rooms %}
        <ul>
            {% for room in recent_rooms %}
                <li>
                    <a class="profile-tags" style="color: #1A3D31; text-decoration: none;" href="{% url 'post_detail' room.id %}">
                        <h3 style="margin-bottom: 10px;">{{ room.title }}</h3>
                    </a>
                    <p style="text-align: left;">{{ room.content }}</p>
                    <small>Created on {{ room.created_at|date:"M d, Y" }}</small>  
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No rooms created yet.</p>
    {% endif %}

    <h2>Recent Activities</h2>
    {% if recent_activities %}
        <div>
            <ul>
                {% for activity in recent_activities %}
                    <li>
                        {% if activity.activity_type == "Post" %}
                            <a style="color: #1A3D31; text-decoration: none;" href="{% url 'post_detail' activity.id %}">
                                Post: {{ activity.title }}
                            </a>
                        {% elif activity.activity_type == "Comment" %}
                            <a style="color: #1A3D31; text-decoration: none;" href="{% url 'post_detail' activity.post.id %}">
                                Comment: {{ activity.content }}
                            </a>
                        {% endif %}
                        {{ activity.created_at|date:"M d, Y H:i" }}
                    </li>
                {% endfor %}
            </ul>
        </div>
    {% else %}
        <p>No recent activities.</p>
    {% endif %}
        <!-- end posts and activies -->
    <!-- Projects Section -->
    <hr style="color:#1A3D31;">
    <div class="completed-projects-container" style="padding-top: 20px; padding-bottom: 30px;">
        <h2 style="margin-bottom: 15px;">Completed Projects</h2>
        <button class="add-project-btn" onclick="toggleProjectForm()" style="background-color: #1A3D31; color: #fff; border: none; border-radius: 5px; padding: 5px 5px; font-size: 14px; display: block; margin: 5px 5px; cursor: pointer; margin-bottom: 10px;">+ Add New Project</button>

        <!-- Project Form (Initially Hidden) -->
        <div id="project-form" class="project-form" style="display: none; margin-top: 20px; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
            <form method="POST" action="{% url 'add_project' %}" onsubmit="validateGitHubLink(event)">
                {% csrf_token %}
                <div class="form-group" style="margin-top: 15px;">
                    <label for="project-name" style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Project Name:</label>
                    <input type="text" id="project-name" name="project_name" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                </div>
    
                <div class="form-group">
                    <label for="project-description" style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Project Description:</label>
                    <textarea id="project-description" name="project_description" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"></textarea>
                </div>
    
                <div class="form-group">
                    <label for="project-link">Project Link:</label>
                    <input type="url" id="project-link" name="project_link" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                </div>
            
                <button type="submit" style="background-color: #1A3D31; color: #fff; border: none; border-radius: 5px; padding: 5px 5px; font-size: 14px; display: block; margin: 5px 5px; cursor: pointer;">Submit Project</button>
            </form>
        </div>

        <!-- Display Existing Projects -->
        {% if projects %}
        <ul class="projects-list">
            {% for project in projects %}
                <li class="project-item" style="display: flex; flex-direction: column; align-items: flex-start; justify-content: space-between; position: relative;">
                    <h3 class="project-title" style="font-size: 20px; font-weight: bold; color:#1A3D31; margin-bottom: 10px;">{{ project.name }}</h3>
                    <p class="project-description" style="font-size: 16px; text-align: left; margin-bottom: 10px;">{{ project.description }}</p>
                    <a class="project-link" href="{{ project.github_link }}" target="_blank" style="text-decoration: none; font-size: 16px;"><b>View Project Here</b></a>


                    <!-- Edit Form (Initially Hidden) -->
                    <div id="edit-form-{{ project.id }}" class="edit-project-form" style="display: none; margin-top: 20px; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); width: 100%;">
                        <form method="POST" action="{% url 'edit_project' project.id %}">
                            {% csrf_token %}
                            <div class="form-group" style="margin-top: 15px;">
                                <label for="edit-project-name-{{ project.id }}" style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Project Name:</label>
                                <input type="text" id="edit-project-name-{{ project.id }}" name="project_name" value="{{ project.name }}" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                            </div>

                            <div class="form-group">
                                <label for="edit-project-description-{{ project.id }}" style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Project Description:</label>
                                <textarea id="edit-project-description-{{ project.id }}" name="project_description" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">{{ project.description }}</textarea>
                            </div>

                            <div class="form-group">
                                <label for="edit-project-link-{{ project.id }}" style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Project Link:</label>
                                <input type="url" id="edit-project-link-{{ project.id }}" name="project_link" value="{{ project.github_link }}" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                            </div>
                
                            <button type="submit" style="background-color: #1A3D31; color: #fff; border: none; border-radius: 5px; padding: 5px 10px; font-size: 14px; cursor: pointer;">Save Changes</button>
                        </form>
                    </div>

                    <div class="profile-delete-edit-btn">
                        <button class="edit-project-btn" onclick="toggleEditForm('{{ project.id }}')" style="background-color: #1A3D31; color: #fff; border: none; border-radius: 5px; font-size: 14px; cursor: pointer; "><b>Edit</b></button>
                        <!-- Delete Form -->
                        <form action="{% url 'delete_project' project.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="delete-btn" style="background-color: #1A3D31; color: #fff; border: none; border-radius: 5px; font-size: 14px; cursor: pointer;" onclick="return confirm('Are you sure you want to delete this project?');">
                                Delete
                            </button>
                        </form>
                    </div>

                </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="no-projects-msg">No projects added yet.</p>
        {% endif %}

    </div>
    <!-- start edit/delete profile -->
    <div class="edit-delete">
        <a href="/settings" style="text-decoration: none;">
        <p>✏️ Edit/Delete Profile</p>
        </a>
    </div>
    <!-- added the edit/delete button -->
</div>



<script>
    function toggleProjectForm() {
        const form = document.getElementById('project-form');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function toggleEditForm(projectId) {
        const editForm = document.getElementById(`edit-form-${projectId}`);
        editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
    }


    function validateGitHubLink(event) {
        // General URL validation pattern
        const urlPattern = /^(https?:\/\/)?([a-zA-Z0-9\-_]+\.)+[a-zA-Z]{2,}(:\d+)?(\/.*)?$/;
        const projectLink = document.getElementById('project-link').value;

        if (!urlPattern.test(projectLink)) {
            alert('Please enter a valid URL.');
            event.preventDefault(); // Prevent the form from being submitted
        }
    }
</script>
{% endblock %}
